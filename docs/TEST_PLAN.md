# 市场创建功能测试计划 (Market Creation Test Plan)

## 📋 测试前准备

### 1. 环境设置
- [ ] 安装 MetaMask 或兼容的 Web3 钱包
- [ ] 连接到 Base Sepolia 测试网络
- [ ] 确保钱包有足够的测试 ETH（至少 0.1 ETH）用于 Gas 费用
- [ ] 访问应用：`http://localhost:3000` 或部署的 URL

### 2. 合约验证
- [ ] 确认 MarketFactoryV2 已部署在 Base Sepolia
- [ ] 合约地址：`0xF3eA8120BEd32a9E5229D832F305BE3335342Cfb`
- [ ] 在 Etherscan 上验证合约状态正常

---

## 🧪 测试用例

### 测试组 1: 基本功能测试

#### TC-001: 连接钱包
**步骤：**
1. 打开应用
2. 点击右上角 "Connect Wallet" 按钮
3. 选择 MetaMask
4. 在 MetaMask 中确认连接

**预期结果：**
- ✅ 钱包成功连接
- ✅ Header 显示钱包地址
- ✅ "Create Market" 按钮出现

**实际结果：** ________________

---

#### TC-002: 打开创建市场模态框
**步骤：**
1. 确保钱包已连接
2. 点击 Header 中的 "+ Create Market" 按钮

**预期结果：**
- ✅ 模态框打开
- ✅ 显示创建市场表单
- ✅ 所有输入字段可见

**实际结果：** ________________

---

#### TC-003: 表单验证 - 空问题
**步骤：**
1. 打开创建市场模态框
2. 不填写任何内容
3. 直接点击 "Create Market" 按钮

**预期结果：**
- ✅ 显示错误提示："Market question is required"
- ✅ 交易不会提交
- ✅ 模态框保持打开状态

**实际结果：** ________________

---

#### TC-004: 表单验证 - 问题过长
**步骤：**
1. 打开创建市场模态框
2. 在问题字段输入超过 200 个字符的文本
3. 点击 "Create Market" 按钮

**预期结果：**
- ✅ 显示字符计数（如 "201/200 characters"）
- ✅ 如果超过限制，显示错误提示
- ✅ 交易不会提交

**实际结果：** ________________

---

#### TC-005: 成功创建市场 - 最小信息
**步骤：**
1. 打开创建市场模态框
2. 填写问题："Will Bitcoin reach $100,000 in 2024?"
3. 不填写其他可选字段
4. 点击 "Create Market"
5. 在 MetaMask 中确认交易
6. 等待交易确认

**预期结果：**
- ✅ 显示 "Waiting for wallet approval..." toast
- ✅ MetaMask 弹出交易确认
- ✅ 确认后显示 "Creating market on blockchain..."
- ✅ 交易成功后显示 "✅ Market created successfully!"
- ✅ 模态框自动关闭
- ✅ 市场列表自动刷新
- ✅ 新创建的市场出现在列表中

**实际结果：** ________________

**交易哈希：** ________________

**市场地址：** ________________

---

#### TC-006: 成功创建市场 - 完整信息
**步骤：**
1. 打开创建市场模态框
2. 填写问题："Will Ethereum implement EIP-7212 before 2025?"
3. 填写描述："This market resolves to YES if EIP-7212 is included in a successful mainnet hard fork on or before Dec 31, 2024."
4. 选择分类：Crypto
5. 设置结束日期：2024-12-31
6. 填写图片 URL：`https://picsum.photos/seed/ethereum/600/400`
7. 点击 "Create Market"
8. 在 MetaMask 中确认交易

**预期结果：**
- ✅ 所有字段正确保存
- ✅ 交易成功提交
- ✅ 新市场包含所有填写的信息

**实际结果：** ________________

**交易哈希：** ________________

---

### 测试组 2: 边界情况测试

#### TC-007: 网络切换
**步骤：**
1. 在 Base Sepolia 网络连接钱包
2. 打开创建市场模态框
3. 切换到其他网络（如 Sepolia）
4. 尝试创建市场

**预期结果：**
- ✅ 显示警告："MarketFactory not deployed on this network"
- ✅ "Create Market" 按钮禁用
- ✅ 提示切换到 Base Sepolia

**实际结果：** ________________

---

#### TC-008: 钱包断开连接
**步骤：**
1. 连接钱包并打开创建市场模态框
2. 在 MetaMask 中断开连接
3. 尝试提交表单

**预期结果：**
- ✅ 显示错误："Please connect your wallet first"
- ✅ 交易不会提交

**实际结果：** ________________

---

#### TC-009: 交易取消
**步骤：**
1. 打开创建市场模态框
2. 填写问题并点击 "Create Market"
3. 在 MetaMask 中点击 "Reject" 取消交易

**预期结果：**
- ✅ 交易被取消
- ✅ 显示错误提示（如果有）
- ✅ 模态框保持打开
- ✅ 可以重新尝试

**实际结果：** ________________

---

#### TC-010: 交易失败（Gas 不足）
**步骤：**
1. 使用余额极低的钱包（< 0.001 ETH）
2. 尝试创建市场

**预期结果：**
- ✅ 显示 Gas 不足错误
- ✅ 错误信息清晰易懂
- ✅ 模态框保持打开

**实际结果：** ________________

---

### 测试组 3: UI/UX 测试

#### TC-011: ESC 键关闭模态框
**步骤：**
1. 打开创建市场模态框
2. 按 ESC 键

**预期结果：**
- ✅ 模态框关闭
- ✅ 表单数据清空（如果未提交）

**实际结果：** ________________

---

#### TC-012: 点击背景关闭模态框
**步骤：**
1. 打开创建市场模态框
2. 点击模态框外的背景区域

**预期结果：**
- ✅ 模态框关闭
- ✅ 如果交易正在进行中，不应关闭

**实际结果：** ________________

---

#### TC-013: 交易进行中禁用关闭
**步骤：**
1. 打开创建市场模态框
2. 提交交易
3. 在交易确认过程中尝试关闭模态框（ESC 或点击背景）

**预期结果：**
- ✅ 模态框不应关闭
- ✅ 关闭按钮应禁用

**实际结果：** ________________

---

#### TC-014: 表单重置
**步骤：**
1. 打开创建市场模态框
2. 填写所有字段
3. 关闭模态框
4. 重新打开模态框

**预期结果：**
- ✅ 所有字段已清空
- ✅ 表单恢复到初始状态

**实际结果：** ________________

---

### 测试组 4: 数据验证测试

#### TC-015: 验证链上市场数据
**步骤：**
1. 成功创建一个市场
2. 获取市场地址（从交易日志或事件）
3. 在 Etherscan 上查看市场合约
4. 验证 `question` 字段

**预期结果：**
- ✅ 市场合约已部署
- ✅ `question` 字段包含提交的问题（可能包含描述）
- ✅ `resolver` 字段是创建者的地址

**实际结果：** ________________

**Etherscan 链接：** ________________

---

#### TC-016: 验证 MarketCreated 事件
**步骤：**
1. 成功创建一个市场
2. 在 Etherscan 上查看交易详情
3. 检查 Events 标签页

**预期结果：**
- ✅ 存在 `MarketCreated` 事件
- ✅ 事件包含正确的 `marketAddress`
- ✅ 事件包含正确的 `question`
- ✅ 事件包含正确的 `creator` 地址

**实际结果：** ________________

---

#### TC-017: 验证市场列表更新
**步骤：**
1. 记录当前市场数量
2. 创建一个新市场
3. 等待交易确认
4. 检查市场列表

**预期结果：**
- ✅ 市场列表自动刷新
- ✅ 新市场出现在列表中
- ✅ 市场数量增加 1

**实际结果：** ________________

**创建前市场数量：** ________________

**创建后市场数量：** ________________

---

### 测试组 5: 性能测试

#### TC-018: 多次快速创建市场
**步骤：**
1. 连续创建 3 个市场
2. 每次创建后等待确认
3. 观察应用响应

**预期结果：**
- ✅ 每次创建都成功
- ✅ 市场列表正确更新
- ✅ 应用性能正常，无卡顿

**实际结果：** ________________

---

#### TC-019: 长时间交易等待
**步骤：**
1. 提交一个市场创建交易
2. 等待交易确认（可能需要几分钟）
3. 观察 UI 状态

**预期结果：**
- ✅ 显示正确的加载状态
- ✅ 用户可以取消或等待
- ✅ 交易最终成功或失败

**实际结果：** ________________

---

## 📊 测试结果总结

### 测试统计
- **总测试用例数：** 19
- **通过：** ___
- **失败：** ___
- **跳过：** ___

### 发现的问题
1. ________________
2. ________________
3. ________________

### 建议改进
1. ________________
2. ________________
3. ________________

---

## 🔍 调试信息收集

### 浏览器控制台
- 打开浏览器开发者工具（F12）
- 查看 Console 标签页的错误和警告
- 记录任何异常信息

### 网络请求
- 查看 Network 标签页
- 检查 RPC 调用是否成功
- 记录失败的请求

### 交易详情
- 记录所有交易哈希
- 在 Etherscan 上验证交易
- 检查 Gas 使用量

---

## ✅ 测试完成检查清单

- [ ] 所有基本功能测试通过
- [ ] 边界情况测试通过
- [ ] UI/UX 测试通过
- [ ] 数据验证测试通过
- [ ] 性能测试通过
- [ ] 所有问题已记录
- [ ] 测试报告已填写

---

## 📝 测试环境信息

**测试日期：** ________________

**测试人员：** ________________

**浏览器：** ________________

**钱包：** ________________

**网络：** Base Sepolia

**合约地址：** 0xF3eA8120BEd32a9E5229D832F305BE3335342Cfb

**应用版本：** Phase 1

---

## 🚨 已知问题

1. **合约限制：** 当前合约只接受问题字符串，描述会合并到问题中
2. **池地址设置：** 创建市场后需要手动调用 `setPoolAddresses` 设置 Uniswap 池
3. **市场数据：** 前端仍使用部分 mock 数据，需要后续集成链上数据

---

## 📞 问题报告

如果发现问题，请记录：
- 问题描述
- 复现步骤
- 预期行为
- 实际行为
- 截图/日志
- 浏览器控制台错误


#### TC-020: Metadata Upload & Retrieval
**步驟：**
1. 建立市場時填寫描述、分類、圖片與結束日期
2. 提供合法的 Pinata JWT（或使用預設 data URI 模式）
3. 交易完成後，於瀏覽器控制台檢查 Question Payload，確認含有 `<metadata:...>` 指標
4. 在首頁確認新市場顯示正確的描述、圖片與分類

**預期結果：**
- ✅ 問題字串末尾包含 metadata URI
- ✅ 市場卡片顯示正確描述、分類、圖片
- ✅ `fetchMarketsFromContract` 能解析 metadata 並呈現

---

#### TC-021: 實時價格與流動性顯示
**步驟：**
1. 連線 Base Sepolia，打開任一鏈上市場
2. 在 Uniswap 內對該市場池子執行 swap/mint，觀察前端
3. 點擊 `Refresh` 或等待自動刷新

**預期結果：**
- ✅ YES/NO 價格顯示與池子狀態同步變化
- ✅ 流動性（USD）總額與池子儲備一致
- ✅ Refresh 按鈕與自動輪詢不會阻塞 UI

---

#### TC-022: Graph / Cache 層驗證（預留）
**目的：** 一旦整合 The Graph 或快取層後，用於驗證索引資料與前端同步性。

**步驟：**
1. 啟動或連線至對應的 Graph Subgraph / 快取 API。
2. 建立或解析一個市場，等待子圖完成索引。
3. 在應用中的 Debug Console（待開發）觸發 `Validate Indexed Data`。
4. 比對 API 回傳與鏈上資料、前端呈現。

**預期結果：**
- ✅ Debug Console 顯示 `Indexed data matches on-chain state`。
- ✅ 若有落差，會列出差異欄位。

---

#### TC-023: Pool Info 顯示
**步驟：**
1. 開啟任一鏈上市場，確認 YES/NO 價格、流動性、池位址顯示。
2. 點擊 `View Pool` 連結，確認導向對應 Basescan 頁面。
3. 模擬池儲備變動（在 AMM 上 swap 或 mint），等待自動刷新或手動 Refresh。

**預期結果：**
- ✅ Modal 中的 Live YES/NO 價格、流動性與實際池狀態一致。
- ✅ `View Pool` 連結可開啟瀏覽器新分頁，地址正確。
- ✅ Refresh 按鈕與輪詢更新不阻塞 UI。

---
